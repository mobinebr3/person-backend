datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum TemplateType {
  CALENDAR
  BOARD
}

enum RecurrenceFreq {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ReminderMethod {
  EMAIL
  PUSH
  SMS
}

enum NotificationType {
  INVITE
  REMINDER
  SYSTEM
  TASK_ASSIGNED
}

enum JobStatus {س
  PENDING
  COMPLETED
  FAILED
}

model User {
  id            String         @id @default(uuid())
  name          String?
  email         String         @unique
  passwordHash  String         @map("password_hash")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  calendars     Calendar[]
  events        Event[]
  tasks         Task[]
  notifications Notification[]
  auditLogs     AuditLog[]
  roles         UserRole[]

  @@map("users")
}

model Role {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  users       UserRole[]

  @@map("roles")
}

model UserRole {
  userId String @map("user_id")
  roleId Int    @map("role_id")
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model Template {
  id        String     @id @default(uuid())
  name      String
  type      String     // "CALENDAR" | "BOARD"
  config    Json
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  calendars Calendar[]

  @@map("templates")
}

model Calendar {
  id         String    @id @default(uuid())
  ownerId    String    @map("owner_id")
  templateId String?   @map("template_id")
  title      String
  color      String?
  isShared   Boolean   @default(false) @map("is_shared")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  owner      User      @relation(fields: [ownerId], references: [id])
  template   Template? @relation(fields: [templateId], references: [id])
  events     Event[]
  tasks      Task[]

  @@map("calendars")
}

model Event {
  id             String           @id @default(uuid())
  calendarId     String           @map("calendar_id")
  ownerId        String           @map("owner_id")
  title          String
  description    String?
  startTimeUtc   DateTime         @map("start_time_utc")
  endTimeUtc     DateTime         @map("end_time_utc")
  isAllDay       Boolean          @default(false) @map("is_all_day")
  isRecurring    Boolean          @default(false) @map("is_recurring")
  recurrenceId   String?          @unique @map("recurrence_id")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  calendar       Calendar         @relation(fields: [calendarId], references: [id])
  owner          User             @relation(fields: [ownerId], references: [id])
  recurrence     EventRecurrence? @relation(fields: [recurrenceId], references: [id])
  instances      EventInstance[]
  reminders      Reminder[]

  @@map("events")
}

model EventRecurrence {
  id           String    @id @default(uuid())
  freq         String    // DAILY, WEEKLY, etc.
  interval     Int       @default(1)
  byDay        String?   @map("by_day")
  byMonthDay   Int?      @map("by_month_day")
  until        DateTime?
  count        Int?
  createdAt    DateTime  @default(now()) @map("created_at")
  event        Event?

  @@map("event_recurrences")
}

model Task {
  id          String   @id @default(uuid())
  calendarId  String   @map("calendar_id")
  ownerId     String   @map("owner_id")
  title       String
  description String?
  status      String  
  order       Int      @default(0)
  dueDate     DateTime? @map("due_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  calendar    Calendar @relation(fields: [calendarId], references: [id])
  owner       User     @relation(fields: [ownerId], references: [id])

  @@map("tasks")
}

model Reminder {
  id            String   @id @default(uuid())
  eventId       String   @map("event_id")
  minutesBefore Int      @map("minutes_before")
  method        String   // مثلاً: EMAIL, PUSH, SMS
  isSent        Boolean  @default(false) @map("is_sent")
  
  event         Event    @relation(fields: [eventId], references: [id])

  @@map("reminders")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // مثلاً: INVITE, REMINDER, SYSTEM
  payload   Json     // ذخیره اطلاعات متغیر به صورت JSON
  isRead    Boolean  @default(false) @map("is_read")
  sentAt    DateTime @default(now()) @map("sent_at")

  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String   // مثلاً: CREATE, UPDATE, DELETE
  entity    String   // نام جدولی که تغییر کرده (مثلاً: Task)
  entityId  String   @map("entity_id") // ID رکوردی که تغییر کرده
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model SchedulerJob {
  id          String   @id @default(uuid())
  jobType     String   @map("job_type")
  referenceId String   @map("reference_id")
  executeAt   DateTime @map("execute_at")
  status      String   @default("PENDING") // PENDING, COMPLETED, FAILED
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("scheduler_jobs")
}

model EventInstance {
  id           String   @id @default(uuid())
  eventId      String   @map("event_id")
  startTimeUtc DateTime @map("start_time_utc")
  endTimeUtc   DateTime @map("end_time_utc")
  isCancelled  Boolean  @default(false) @map("is_cancelled")
  
  event        Event    @relation(fields: [eventId], references: [id])

  @@map("event_instances")
}